{% extends 'base.html' %}

{% block title %}{{ user_info.nickname or username }} - ç”¨æˆ·èµ„æ–™{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-3">
                        {% if user_info.avatar %}
                        <img src="{{ user_info.avatar }}" class="rounded-circle" width="100" height="100" alt="å¤´åƒ">
                        {% else %}
                        <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                            <i class="fas fa-user fa-3x text-white"></i>
                        </div>
                        {% endif %}
                    </div>
                    <h4 class="card-title">{{ user_info.nickname or username }}</h4>
                    <p class="text-muted">@{{ username }}</p>
                    
                    {% if user_info.bio %}
                    <p class="card-text">{{ user_info.bio }}</p>
                    {% endif %}
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <strong>{{ user_info.followers|length if user_info.followers else 0 }}</strong>
                            <div class="text-muted small">ç²‰ä¸</div>
                        </div>
                        <div class="col-4">
                            <strong>{{ user_info.following|length if user_info.following else 0 }}</strong>
                            <div class="text-muted small">å…³æ³¨</div>
                        </div>
                        <div class="col-4">
                            <strong>{{ rated_movies|length }}</strong>
                            <div class="text-muted small">è¯„åˆ†</div>
                        </div>
                    </div>
                    
                    {% if user_info.interests %}
                    <div class="mb-3">
                        <h6>å…´è¶£æ ‡ç­¾</h6>
                        {% for interest in user_info.interests %}
                        <span class="badge bg-secondary me-1">{{ interest }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if session.username and session.username != username %}
                    <div class="d-grid gap-2">
                        <form method="post" action="{{ url_for('follow_user', username=username) }}">
                            <button type="submit" class="btn btn-primary">å…³æ³¨</button>
                        </form>
                    </div>
                    {% elif is_own_profile %}
                    <div class="d-grid">
                        <a href="{{ url_for('edit_profile') }}" class="btn btn-primary edit-profile-btn" 
                           id="editProfileBtn" 
                           onclick="console.log('ç¼–è¾‘èµ„æ–™æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘'); return true;"
                           style="pointer-events: auto !important; z-index: 99999 !important; position: relative !important; cursor: pointer !important;">
                            <i class="fas fa-edit me-2"></i>ç¼–è¾‘èµ„æ–™
                        </a>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3 text-muted small">
                        æ³¨å†Œæ—¶é—´: {{ user_info.registered_at.strftime('%Yå¹´%mæœˆ%dæ—¥') }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·è¯„åˆ†çš„ç”µå½± -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-star text-warning me-2"></i>
                        è¯„åˆ†è¿‡çš„ç”µå½± ({{ rated_movies|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if rated_movies %}
                    <div class="row">
                        {% for movie in rated_movies[:12] %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 movie-card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="{{ url_for('movie_detail', movie_id=movie.movieId) }}" 
                                           class="text-decoration-none">
                                            {{ movie.title[:40] }}{% if movie.title|length > 40 %}...{% endif %}
                                        </a>
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">{{ movie.genres }}</small>
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="rating">
                                            {% for i in range(1, 6) %}
                                                {% if i <= movie.user_rating %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-muted"></i>
                                                {% endif %}
                                            {% endfor %}
                                            <span class="text-muted ms-1">({{ movie.user_rating }})</span>
                                        </div>
                                    </div>
                                    {% if movie.user_comment %}
                                    <div class="mt-2">
                                        <small class="text-muted">{{ movie.user_comment[:50] }}{% if movie.user_comment|length > 50 %}...{% endif %}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if rated_movies|length > 12 %}
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary" onclick="showMoreMovies()">æŸ¥çœ‹æ›´å¤š</button>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-film fa-3x mb-3"></i>
                        <p>è¿˜æ²¡æœ‰è¯„åˆ†è¿‡ä»»ä½•ç”µå½±</p>
                        {% if is_own_profile %}
                        <a href="{{ url_for('search') }}" class="btn btn-primary">å»è¯„åˆ†ç”µå½±</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ç”¨æˆ·èµ„æ–™é¡µé¢æ ·å¼ä¼˜åŒ– */
.movie-card {
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.movie-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.rating .fas.fa-star {
    color: #ffc107;
}

.rating .far.fa-star {
    color: #6c757d;
}

/* ç¡®ä¿æ‰€æœ‰è¾“å…¥æ¡†å’Œè¡¨å•å…ƒç´ å¯ç”¨ */
.card-body input.form-control,
.card-body input[type="text"],
.card-body input[type="email"],
.card-body textarea.form-control,
.card-body select.form-select,
.card-body button[type="submit"] {
    background: rgba(255, 255, 255, 0.95) !important;
    border: 2px solid rgba(255, 255, 255, 0.3) !important;
    color: #2c3e50 !important;
    border-radius: 12px !important;
    padding: 12px 16px !important;
    font-size: 16px !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
    width: 100% !important;
    height: auto !important;
    line-height: 1.5 !important;
    font-family: inherit !important;
    /* ç¡®ä¿å®Œå…¨å¯äº¤äº’ */
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
    position: relative !important;
    z-index: 1000 !important;
    overflow: visible !important;
    outline: none !important;
    /* æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„å¹²æ‰° */
    transform: none !important;
    clip: none !important;
    clip-path: none !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
}

.card-body button[type="submit"] {
    background: linear-gradient(135deg, #3498db, #5dade2) !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
}

.card-body button[type="submit"]:hover {
    background: linear-gradient(135deg, #2980b9, #3498db) !important;
    transform: translateY(-2px) !important;
}

.card-body input.form-control:focus,
.card-body input[type="text"]:focus,
.card-body input[type="email"]:focus,
.card-body textarea.form-control:focus,
.card-body select.form-select:focus {
    background: rgba(255, 255, 255, 1) !important;
    border-color: #3498db !important;
    box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25), 0 4px 15px rgba(0, 0, 0, 0.1) !important;
    color: #2c3e50 !important;
    outline: none !important;
    transform: none !important;
    z-index: 1001 !important;
}

.card-body input.form-control::placeholder,
.card-body input[type="text"]::placeholder,
.card-body input[type="email"]::placeholder,
.card-body textarea.form-control::placeholder {
    color: #7f8c8d !important;
    opacity: 0.8 !important;
    font-style: italic !important;
}

/* ç¡®ä¿è¡¨å•å®¹å™¨å¯äº¤äº’ */
.card-body,
.card-body form,
.card-body form *,
.d-grid {
    overflow: visible !important;
    pointer-events: auto !important;
}

/* ä¿®å¤ç¼–è¾‘èµ„æ–™é“¾æ¥æŒ‰é’® */
.d-grid a.btn,
.d-grid a.btn-primary,
a.btn,
a.btn-primary {
    /* ç¡®ä¿é“¾æ¥æŒ‰é’®å®Œå…¨å¯ç‚¹å‡» */
    pointer-events: auto !important;
    cursor: pointer !important;
    position: relative !important;
    z-index: 1000 !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    overflow: visible !important;
    
    /* æ¸…é™¤å¹²æ‰°æ ·å¼ */
    transform: none !important;
    clip: none !important;
    clip-path: none !important;
    
    /* ç¾åŒ–æ ·å¼ */
    background: linear-gradient(135deg, #3498db, #5dade2) !important;
    color: #ffffff !important;
    border: none !important;
    border-radius: 12px !important;
    padding: 12px 16px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    text-decoration: none !important;
    text-align: center !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3) !important;
}

.d-grid a.btn:hover,
.d-grid a.btn-primary:hover,
a.btn:hover,
a.btn-primary:hover {
    background: linear-gradient(135deg, #2980b9, #3498db) !important;
    color: #ffffff !important;
    text-decoration: none !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4) !important;
}

.d-grid a.btn:active,
.d-grid a.btn-primary:active,
a.btn:active,
a.btn-primary:active {
    transform: translateY(0px) !important;
}

/* è¶…å¼ºåŠ›ä¿®å¤ç¼–è¾‘èµ„æ–™æŒ‰é’® */
#editProfileBtn,
.edit-profile-btn,
a[href*="edit_profile"] {
    /* ç»å¯¹ç¡®ä¿å¯ç‚¹å‡» */
    pointer-events: auto !important;
    cursor: pointer !important;
    position: relative !important;
    z-index: 9999 !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    overflow: visible !important;
    
    /* æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„å¹²æ‰° */
    transform: none !important;
    clip: auto !important;
    clip-path: none !important;
    mask: none !important;
    -webkit-mask: none !important;
    
    /* å¼ºåˆ¶è®¾ç½®æœ‰æ•ˆçš„é“¾æ¥æ ·å¼ */
    background: linear-gradient(135deg, #3498db, #5dade2) !important;
    color: #ffffff !important;
    border: 2px solid #3498db !important;
    border-radius: 12px !important;
    padding: 14px 20px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    text-decoration: none !important;
    text-align: center !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3) !important;
    width: 100% !important;
    height: auto !important;
    min-height: 45px !important;
    line-height: 1.4 !important;
}

#editProfileBtn:hover,
.edit-profile-btn:hover,
a[href*="edit_profile"]:hover {
    background: linear-gradient(135deg, #2980b9, #3498db) !important;
    color: #ffffff !important;
    text-decoration: none !important;
    transform: translateY(-2px) scale(1.02) !important;
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4) !important;
    border-color: #2980b9 !important;
}

#editProfileBtn:active,
.edit-profile-btn:active,
a[href*="edit_profile"]:active {
    transform: translateY(0px) scale(1) !important;
    box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3) !important;
}

#editProfileBtn:focus,
.edit-profile-btn:focus,
a[href*="edit_profile"]:focus {
    outline: 3px solid rgba(52, 152, 219, 0.5) !important;
    outline-offset: 2px !important;
    z-index: 10000 !important;
}
</style>

<script>
function showMoreMovies() {
    // è¿™é‡Œå¯ä»¥æ·»åŠ AJAXåŠ è½½æ›´å¤šç”µå½±çš„åŠŸèƒ½
    alert('åŠŸèƒ½å¼€å‘ä¸­...');
}

// ç”¨æˆ·èµ„æ–™é¡µé¢è¾“å…¥æ¡†ä¿®å¤è„šæœ¬
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== ç”¨æˆ·èµ„æ–™é¡µé¢è°ƒè¯•ä¿¡æ¯ ===');
    
    // è¶…å¼ºåŠ›ä¿®å¤ç¼–è¾‘èµ„æ–™æŒ‰é’®
    const editButtons = [
        document.getElementById('editProfileBtn'),
        document.querySelector('.edit-profile-btn'),
        document.querySelector('a[href*="edit_profile"]')
    ].filter(btn => btn !== null);
    
    if (editButtons.length > 0) {
        console.log('æ‰¾åˆ°ç¼–è¾‘èµ„æ–™æŒ‰é’®æ•°é‡:', editButtons.length, editButtons);
        
        editButtons.forEach((editButton, index) => {
            console.log(`å¤„ç†ç¼–è¾‘èµ„æ–™æŒ‰é’® ${index + 1}:`, editButton);
            
            // è¶…å¼ºåŠ›æ ·å¼ä¿®å¤
            const superStyles = {
                'pointer-events': 'auto',
                'cursor': 'pointer',
                'position': 'relative',
                'z-index': '9999',
                'display': 'block',
                'visibility': 'visible',
                'opacity': '1',
                'overflow': 'visible',
                'transform': 'none',
                'clip': 'auto',
                'clip-path': 'none',
                'mask': 'none',
                '-webkit-mask': 'none',
                'background': 'linear-gradient(135deg, #3498db, #5dade2)',
                'color': '#ffffff',
                'border': '2px solid #3498db',
                'border-radius': '12px',
                'padding': '14px 20px',
                'font-size': '16px',
                'font-weight': '600',
                'text-decoration': 'none',
                'text-align': 'center',
                'width': '100%',
                'min-height': '45px'
            };
            
            Object.entries(superStyles).forEach(([prop, value]) => {
                editButton.style.setProperty(prop, value, 'important');
            });
            
            // ç§»é™¤å¯èƒ½çš„ç¦ç”¨å±æ€§
            editButton.removeAttribute('disabled');
            editButton.removeAttribute('readonly');
            
            // ç¡®ä¿hrefå±æ€§å­˜åœ¨ - ç»ˆæä¿®å¤ç‰ˆ
            if (!editButton.href || editButton.href === '#' || editButton.href.includes('#')) {
                const editUrl = '/profile/edit';
                editButton.href = editUrl;
                editButton.setAttribute('href', editUrl);
                console.log('âœ… å¼ºåˆ¶è®¾ç½®ç¼–è¾‘æŒ‰é’®hrefä¸º:', editUrl);
            }
            
            // ç»ˆæä¿®å¤ï¼šç›´æ¥åœ¨æŒ‰é’®ä¸Šç»‘å®šå¼ºåˆ¶è·³è½¬
            editButton.onclick = function(e) {
                e.preventDefault();
                console.log('ğŸš€ ç¼–è¾‘èµ„æ–™æŒ‰é’®å¼ºåˆ¶è·³è½¬è§¦å‘!');
                const targetUrl = '/profile/edit';
                console.log('è·³è½¬åˆ°:', targetUrl);
                window.location.href = targetUrl;
                return false;
            };
            
            // å¤šé‡ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            ['click', 'mousedown', 'touchstart'].forEach(eventType => {
                editButton.addEventListener(eventType, function(e) {
                    console.log(`ç¼–è¾‘èµ„æ–™æŒ‰é’® ${eventType} äº‹ä»¶è§¦å‘!`, this.href);
                    if (eventType === 'click') {
                        if (this.href && this.href !== '#') {
                            console.log('âœ… ç¼–è¾‘èµ„æ–™æŒ‰é’®ç‚¹å‡»æˆåŠŸï¼Œæ­£åœ¨è·³è½¬åˆ°:', this.href);
                            // å¼ºåˆ¶è·³è½¬ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
                            setTimeout(() => {
                                if (window.location.href === this.href) {
                                    console.log('âœ… é¡µé¢è·³è½¬æˆåŠŸ');
                                } else {
                                    console.log('ğŸ”„ æ‰‹åŠ¨è·³è½¬é¡µé¢');
                                    window.location.href = this.href;
                                }
                            }, 100);
                        } else {
                            e.preventDefault();
                            console.error('âŒ ç¼–è¾‘èµ„æ–™æŒ‰é’®æ²¡æœ‰æœ‰æ•ˆçš„hrefå±æ€§');
                            // æ‰‹åŠ¨è·³è½¬
                            window.location.href = '{{ url_for("edit_profile") }}';
                        }
                    }
                }, true); // ä½¿ç”¨æ•è·é˜¶æ®µ
            });
            
            // æ‚¬åœæ•ˆæœ
            editButton.addEventListener('mouseenter', function() {
                console.log('ç¼–è¾‘èµ„æ–™æŒ‰é’®æ‚¬åœ');
                this.style.setProperty('background', 'linear-gradient(135deg, #2980b9, #3498db)', 'important');
                this.style.setProperty('transform', 'translateY(-2px) scale(1.02)', 'important');
            });
            
            editButton.addEventListener('mouseleave', function() {
                this.style.setProperty('background', 'linear-gradient(135deg, #3498db, #5dade2)', 'important');
                this.style.setProperty('transform', 'none', 'important');
            });
            
            // ç„¦ç‚¹æµ‹è¯•
            setTimeout(() => {
                try {
                    editButton.focus();
                    console.log(`âœ… ç¼–è¾‘èµ„æ–™æŒ‰é’® ${index + 1} å¯ä»¥è·å¾—ç„¦ç‚¹`);
                    
                    // æ¨¡æ‹Ÿç‚¹å‡»æµ‹è¯•
                    setTimeout(() => {
                        editButton.blur();
                        // æµ‹è¯•ç‚¹å‡»åŒºåŸŸ
                        const rect = editButton.getBoundingClientRect();
                        console.log(`ç¼–è¾‘æŒ‰é’® ${index + 1} ä½ç½®:`, {
                            top: rect.top,
                            left: rect.left,
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                    }, 200);
                } catch (e) {
                    console.error(`âŒ ç¼–è¾‘èµ„æ–™æŒ‰é’® ${index + 1} æ— æ³•è·å¾—ç„¦ç‚¹:`, e);
                }
            }, 500 * (index + 1));
        });
    } else {
        console.log('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•ç¼–è¾‘èµ„æ–™æŒ‰é’® - å¯èƒ½ä¸æ˜¯è‡ªå·±çš„èµ„æ–™é¡µé¢');
    }
    
    // è·å–æ‰€æœ‰è¾“å…¥æ¡†å’ŒæŒ‰é’®
    const inputs = document.querySelectorAll('.card-body input, .card-body textarea, .card-body select, .card-body button, a.btn');
    console.log('å‘ç°äº¤äº’å…ƒç´ æ•°é‡:', inputs.length);
    
    inputs.forEach((input, index) => {
        console.log(`äº¤äº’å…ƒç´  ${index + 1}:`, {
            tagName: input.tagName,
            type: input.type,
            className: input.className
        });
        
        // å¼ºåˆ¶è®¾ç½®å…ƒç´ å±æ€§
        input.style.pointerEvents = 'auto';
        input.style.position = 'relative';
        input.style.zIndex = '1000';
        input.style.overflow = 'visible';
        input.style.opacity = '1';
        input.style.visibility = 'visible';
        input.style.transform = 'none';
        
        // ç§»é™¤å¯èƒ½çš„å¹²æ‰°å±æ€§
        input.removeAttribute('readonly');
        input.removeAttribute('disabled');
        
        // ä¸ºè¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA' || input.tagName === 'SELECT') {
            input.addEventListener('focus', function() {
                console.log('ç”¨æˆ·èµ„æ–™é¡µé¢å…ƒç´ è·å¾—ç„¦ç‚¹:', this.name || this.id || this.tagName);
                this.style.zIndex = '1001';
            });
            
            input.addEventListener('blur', function() {
                console.log('ç”¨æˆ·èµ„æ–™é¡µé¢å…ƒç´ å¤±å»ç„¦ç‚¹:', this.name || this.id || this.tagName);
                this.style.zIndex = '1000';
            });
            
            input.addEventListener('input', function() {
                console.log('ç”¨æˆ·èµ„æ–™é¡µé¢è¾“å…¥å†…å®¹:', this.name || this.id || this.tagName, '=', this.value);
            });
        }
        
        // ä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨
        if (input.tagName === 'BUTTON') {
            input.addEventListener('click', function(e) {
                console.log('ç”¨æˆ·èµ„æ–™é¡µé¢æŒ‰é’®è¢«ç‚¹å‡»:', this.textContent.trim());
            });
        }
    });
    
    console.log('=== ç”¨æˆ·èµ„æ–™é¡µé¢è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
    
    // ç»ˆæé¡µé¢çŠ¶æ€æ£€æŸ¥
    setInterval(function() {
        const editBtn = document.getElementById('editProfileBtn');
        if (editBtn) {
            const rect = editBtn.getBoundingClientRect();
            console.log('âš¡ ç¼–è¾‘æŒ‰é’®çŠ¶æ€æ£€æŸ¥:', {
                å¯è§: rect.width > 0 && rect.height > 0,
                href: editBtn.href,
                æ ·å¼: window.getComputedStyle(editBtn).pointerEvents,
                zIndex: window.getComputedStyle(editBtn).zIndex
            });
        }
    }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
});

// é¡µé¢å¯è§æ€§ç›‘å¬ - ç¡®ä¿è¿”å›é¡µé¢æ—¶åŠŸèƒ½æ­£å¸¸
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        console.log('ğŸ”„ é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°åˆå§‹åŒ–èµ„æ–™é¡µé¢åŠŸèƒ½');
        setTimeout(() => {
            const editBtn = document.getElementById('editProfileBtn');
            if (editBtn) {
                editBtn.style.setProperty('pointer-events', 'auto', 'important');
                editBtn.style.setProperty('z-index', '99999', 'important');
                editBtn.onclick = function(e) {
                    e.preventDefault();
                    console.log('ğŸš€ ç¼–è¾‘èµ„æ–™æŒ‰é’®å¼ºåˆ¶è·³è½¬è§¦å‘!');
                    window.location.href = '/profile/edit';
                    return false;
                };
            }
        }, 100);
    }
});
</script>
{% endblock %} 